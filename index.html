<!DOCTYPE html>
<html>

<head>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="apple-touch-icon" href="launch.png">
  <link rel="apple-touch-startup-image" href="launch.png">
  <meta name="apple-mobile-web-app-title" content="Push To Telescope">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

</head>

<body>

  <script>
    addEventListener('load', function(e) {

      cl = (arg) => console.log(arg)
      makeObject = (array, names) => {
        o = {}
        names.map((v, i) => o[v] = array[i])
        return o
      }
      r = 67
      shuffle = (a, b) => Math.random(r) - 0.5

      //MODEL

      patternIndex = 0
      question = true
      substitutedWordIndex = 0
      englishSentenceText = " "
      maoriSentenceText = " "
      maoriAnswerText = "."
      gridWords = []
      sentenceCorrect = false

      patternsCSV = [
        "what is/am/are [pronoun] doing,kei te aha [pronoun], [pronoun] is/am/are [verb],kei te [verb] [pronoun]",
        "what is the time,ko te aha te wa,the time is [time],ko te [time] te wa",
        "what day is it,ko te aha tēnei rā,the day is [day],ko te [day] tēnei rā",
        "what month is this,ko te aha tēnei marama,the month is [month],ko [month] tēnei marama",
        "how many [relation] do you have,tokohia āu [relation],I have rima [relation],tokohia rima (t)ōku [relation]",
        "how are you feeling?,kei te pehea koe,I am feeling [feeling],kei te [feeling] ahau",
        "where are you from?,nō hea koe,I am from [place],nō [place] ahau",
        "where is Mere,kei hea a Mere,Mere is [locative] the house,kei [locative] a Mere i te whare",
        "who is/are your [relation],ko wai [relation],My [relation] is Mere,ko Mere (t)ōku [relation]"

      ]

      tupuCSV = [
        "place,Dunedin,Onetāhi",
        "place,Auckland,Tamaki Makaurau",
        "place,One Tree Hill,Maungakiekie",
        "feeling,happy,hari",
        "feeling,bored,hōhā",
        "feeling,sick,māuiui",
        "feeling,angry,pukuriri",
        "feeling,sleepy,hiamoe",
        "feeling,surprised,ohorere",
        "feeling,overjoyed,harikoa",
        "feeling,confused,rangirua",
        "feeling,hot,wera",
        "feeling,cold,makariri",
        "feeling,good,pai",
        "cardinal,one,kotahi",
        "cardinal,two,rua",
        "cardinal,three,toru",
        "relation,father,matua",
        "relation,mother,whaea",
        "time,2:10,tekau mai i te rua",
        "time,3:30,haurua mai i te toru",
        "time,12:45,hauwha ki te tahi",
        "time,4:50,tekau ki te rima",
        "time,8:24,rua tekau mai i te waru",
        "day,monday,Rāhina",
        "day,tueday,Rātū",
        "day,wednesday,Rāapa",
        "day,Thursday,Rāpare",
        "day,Friday,Rāmere",
        "day,Saturday,Rāhoroi",
        "day,Sunday,Rātapu",
        "month,January,Kohitātea",
        "month,February,Hui-tanguru",
        "month,March,Poutū-te-rangi",
        "month,April,Paenga-whāwhā",
        "month,May,Haratua",
        "month,June,Pipiri",
        "month,July,Hōngongoi",
        "month,August,Here-turi-kōkā",
        "month,September,Mahuru",
        "month,October,Whiringa-ā-nuku",
        "month,November,Whiringa-ā-rangi",
        "month,December,Hakihea",
        "locative,under,raro",
        "locative,on,runga",
        "locative,outside,waho",
        "locative,inside,roto",
        "locative,behind,muri",
        "locative,in front,mua",
        "locative,waenganui,between",
        "locative,konei,by me",
        "locative,konā,by you",
        "locative,kora,by them",
        "locative,overseas,tāwāhi",
        "pronoun,I/me,ahau",
        "pronoun,you,koe",
        "pronoun,him/her,ia",
        "pronoun,we (2 including you),tāua",
        "pronoun,we (3+ including you),tātou",
        "pronoun,we (2 but not you),māua",
        "pronoun,we (3+ but not you),mātou",
        "pronoun,you (2),kōrua",
        "pronoun,you (3+),koutou",
        "pronoun,they (2),rāua",
        "pronoun,they (3+),rātou",
        "verb,eating,kai",
        "verb,singing,waiata",
        "verb,sleeping,moe",
        "verb,walking,hikoi"



      ]

      patterns = []
      patternsCSV.forEach(v => patterns.push(makeObject(v.split(","), ["englishQ", "maoriQ", "englishA", "maoriA"])))

      tupus = []
      tupuCSV.forEach(v => tupus.push(makeObject(v.split(","), ["topic", "english", "maori"])))
      tupus.sort(shuffle)


      substituteEnglishVariableWord = (str) => {
        variableWord = str.match(/\[(\w+)\]/g)
        s = str
        if (variableWord != null) {
          variableWord.forEach((item) => {
            item = item.replace("[", "").replace("]", "")
            variableWords = tupus.filter(v => (v.topic == item))
            s = s.replace("[" + item + "]", variableWords[substitutedWordIndex].english)
          })
        }
        return s
      }

      substituteMaoriVariableWord = (str) => {
        variableWord = str.match(/\[(\w+)\]/g)
        s = str
        if (variableWord != null) {
          variableWord.forEach((item) => {
            item = item.replace("[", "").replace("]", "")
            variableWords = tupus.filter(v => (v.topic == item))
            s = s.replace("[" + item + "]", variableWords[substitutedWordIndex].maori)
          })
        }
        return s
      }

      //  substitutedWordIndex = (substitutedWordIndex == tupus.filter(v => v.topic == variableWord[1]).length) ? 0 : substitutedWordIndex++


      makeSentences = (patternIndex, question) => {
        if (question) {
          englishSentenceText = substituteEnglishVariableWord(patterns[patternIndex].englishQ)
          maoriSentenceText = substituteMaoriVariableWord(patterns[patternIndex].maoriQ)
        } else {
          englishSentenceText = substituteEnglishVariableWord(patterns[patternIndex].englishA)
          maoriSentenceText = substituteMaoriVariableWord(patterns[patternIndex].maoriA)
        }
      }

      maoriWordList = () => {
        list = []
        patterns.forEach(v => list = [...list, ...v.maoriQ.replace(/ \[(\w+)\]/, "").split(" ")])
        return list
      }

      topicWordList = () => {
        list = []
        str = question ? patterns[patternIndex].englishQ : patterns[patternIndex].englishA
        variableWord = str.match(/\[(\w+)\]/)
        if (variableWord != null) {
          tupus.filter(v => v.topic == variableWord[1]).forEach(v => list = [...list, ...v.maori.split(" ")])
        }
        return list
      }

      makeGridWords = () => {
        words = maoriSentenceText.replace(/\[(\w+)\]/, "").split(" ")
        words = [...words, ...maoriWordList(), ...topicWordList()] //, ...["tōku", "rāua", "ki", "ō", "aha", "koutou", "ona", "tōu", "haere", "māua", "i", "etahi"]]
        words = [...new Set(words)]
        words = words.slice(0, 24)
        words = words.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()))
        gridWords = words
      }

      updateModel = () => {
        makeSentences(patternIndex, question)
        makeGridWords()
      }

      //VIEW

      addElement = (id, elementType, container, width, style, text) => {
        element = document.createElement(elementType)
        element.style.cssText = style
        element.style.width = width + "%"
        element.id = id
        element.innerHTML = text
        container.appendChild(element)
        return element
      }

      buttonStyle = "position:relative;color:black;background:ivory;border-style:solid;border-width:1px;font-size:3vw;font-family:verdana;"
      buttonLeftStyle = buttonStyle + "position:relative;float:left;"
      buttonRightStyle = buttonStyle + "position:relative;right:0;"
      divStyle = "position:relative;display:block;border-style:none;border-width:1px;font-size:3vw;font-family:verdana;"

      //sentenceStyle = "color:black;background-color:ivory;border-style:solid;border-width:1px;font-size:3vw;font-family:verdana;"
      correctButtonStyle = "color:limeGreen;background-color:ivory;border-style:solid;border-width:1px;font-size:3vw;font-family:verdana;"

      display = () => {
        updateModel()
        cl(maoriAnswerText)
        document.body.innerHTML = ""
        b = addElement(1, "div", document.body, 100, "", "")
        b.addEventListener("click", clicked)

        englishDiv = addElement("englishDiv", "div", b, 100, divStyle, "")
        redoButton = addElement("redoButton", "button", englishDiv, 15, buttonLeftStyle, "@")
        englishSentence = addElement("englishSentence", "button", englishDiv, 70, buttonStyle, englishSentenceText)
        nextPatternButton = addElement("nextPatternButton", "button", englishDiv, 15, buttonRightStyle, ">")

        maoriDiv = addElement("maoriDiv", "div", b, 100, divStyle, "")
        maoriSentenceElement = addElement("maoriSentence", "button", maoriDiv, 85, sentenceCorrect ? correctButtonStyle : buttonStyle, maoriAnswerText)
        deleteButton = addElement("deleteButton", "button", maoriDiv, 15, buttonRightStyle, "del")

        wordGrid = addElement("wordGrid", "div", b, 100, divStyle, "")
        gridWords.forEach((v, i) => addElement("tupu" + i, "button", wordGrid, 33.33, buttonStyle, v))
      }

      //CONTROLLER

      clicked = e => {
        id = e.target.id

        if (id == "nextPatternButton") {
          question = !question
          if (question) {
            patternIndex = (patternIndex == patterns.length - 1) ? 0 : patternIndex + 1
          }
          substitutedWordIndex = 0
          maoriAnswerText = "."
          sentenceCorrect = false
        }

        if (id == "englishSentence") {
          alert(maoriSentenceText)
        }

        if (id.includes("tupu")) {
          maoriAnswerText = maoriAnswerText + " " + gridWords[id.match(/\d+/g)]
          maoriAnswerText = maoriAnswerText.replace(".", "")
          if (maoriAnswerText.trim() == substituteMaoriVariableWord(patterns[patternIndex].maoriQ) ||
            maoriAnswerText.trim() == substituteMaoriVariableWord(patterns[patternIndex].maoriA))
            sentenceCorrect = true
        }

        if (id == "deleteButton") {
          maoriAnswerText = maoriAnswerText.substring(0, maoriAnswerText.lastIndexOf(" "))
          sentenceCorrect = false
        }

        if (id == "redoButton") {
          maoriAnswerText = "."
          substitutedWordIndex++
          sentenceCorrect = false
        }
        display()
      }

      display()
    })
  </script>
</body>

</html>
